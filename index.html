<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verdant Whispers Player Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 1.5rem 1rem 2.5rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      background:
        radial-gradient(circle at top, rgba(59,130,246,0.25), transparent 60%),
        radial-gradient(circle at bottom, rgba(16,185,129,0.18), transparent 55%),
        #020617;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: rgba(15,23,42,0.9);
      border-radius: 1.8rem;
      padding: 1.8rem 1.4rem 2.2rem;
      box-shadow:
        0 30px 80px rgba(0,0,0,0.8),
        0 0 0 1px rgba(148,163,184,0.35);
      backdrop-filter: blur(22px);
      position: relative;
      overflow: hidden;
    }

    /* Glows */
    .glow {
      position: absolute;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      pointer-events: none;
      z-index: -1;
    }
    .glow.blue {
      width: 280px; height: 280px;
      top: -80px; right: -60px;
      background: rgba(59,130,246,0.7);
    }
    .glow.teal {
      width: 300px; height: 300px;
      bottom: -120px; left: -80px;
      background: rgba(45,212,191,0.7);
    }

    /* Header */
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1.4rem;
    }
    .title-block { display: flex; flex-direction: column; gap: 0.35rem; }
    .title-line { display: flex; align-items: center; gap: 0.7rem; }

    .app-title {
      font-size: clamp(1.8rem, 2.6vw + 1rem, 2.6rem);
      font-weight: 800;
      letter-spacing: 0.04em;
    }
    .live-badge {
      padding: 0.15rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.8);
      background: radial-gradient(circle at top left, rgba(220,38,38,0.85), rgba(127,29,29,0.9));
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #fee2e2;
      box-shadow: 0 0 20px rgba(239,68,68,0.7);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .live-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: #fee2e2;
      box-shadow: 0 0 12px rgba(254,202,202,0.9);
    }

    .season-tag {
      font-size: 0.8rem;
      color: #9ca3af;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      white-space: nowrap;
    }
    .status-dot {
      width: 7px; height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.9);
    }

    /* Summary cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.6rem;
    }
    @media (min-width: 768px) {
      .summary-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .summary-card {
      position: relative;
      border-radius: 1rem;
      padding: 0.8rem 0.9rem;
      border: 1px solid rgba(148,163,184,0.45);
      background: radial-gradient(circle at top left, rgba(37,99,235,0.35), rgba(15,23,42,0.98));
      box-shadow: 0 18px 35px rgba(15,23,42,0.9);
      overflow: hidden;
      backdrop-filter: blur(18px);
      transform: translateY(0);
      animation: floatCard 7s ease-in-out infinite;
    }
    .summary-card:nth-child(2) { animation-delay: 0.6s; }
    .summary-card:nth-child(3) { animation-delay: 1.2s; }
    .summary-card:nth-child(4) { animation-delay: 1.8s; }

    @keyframes floatCard {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .summary-label {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #bfdbfe;
      margin-bottom: 0.2rem;
    }
    .summary-value { font-size: 1.2rem; font-weight: 700; }
    .summary-sub {
      font-size: 0.72rem;
      color: #e5e7eb;
      opacity: 0.85;
      margin-top: 0.1rem;
    }

    .summary-glow { display: false; }

    /* Table card */
    .table-card {
      border-radius: 1.2rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(12,18,34,0.98));
      overflow: hidden;
      box-shadow: 0 25px 45px rgba(15,23,42,1);
    }
    .table-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0.9rem 0.5rem;
      border-bottom: 1px solid rgba(30,64,175,0.7);
      background: radial-gradient(circle at top left, rgba(37,99,235,0.5), rgba(15,23,42,0.95));
    }
    .table-title { font-size: 0.95rem; font-weight: 600; }
    .table-subtitle { font-size: 0.75rem; color: #cbd5f5; opacity: 0.85; }
    .controls { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }

    .search-input {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      color: #e5e7eb;
      min-width: 160px;
      outline: none;
      box-shadow: 0 0 0 1px transparent;
      transition: 0.15s ease;
    }

    .status-chip { font-size: 0.7rem; color: #cbd5f5; display: flex; align-items: center; gap: 0.35rem; }
    .tiny-spinner {
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,0.6);
      border-top-color: #60a5fa;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .table-scroll { max-height: 60vh; overflow:auto; }

    table { width:100%; border-collapse:collapse; min-width:840px; }
    thead { position: sticky; top:0; z-index:3; background: #020617; }

    th, td {
      padding: 0.45rem 0.4rem;
      font-size: 0.78rem;
      white-space: nowrap;
      border-bottom: 1px solid rgba(30,64,175,0.4);
    }

    th:first-child, td:first-child {
      text-align:left;
      position:sticky; left:0; background:inherit; z-index:4;
    }

    th:not(:first-child), td:not(:first-child) { text-align:center; }

    th {
      font-weight:600;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .sort-icon { font-size:0.7rem; opacity:0.25; transition:0.15s ease; }
    th.sorted-asc .sort-icon,
    th.sorted-desc .sort-icon { opacity:1; color:#38bdf8; }
    th.sorted-asc .sort-icon { transform:rotate(180deg); }

    tbody tr:nth-child(even) { background:rgba(15,23,42,0.95); }
    tbody tr:nth-child(odd) { background:rgba(15,23,42,0.9); }
    tbody tr:hover { background:rgba(37,99,235,0.35); }

    .player-cell { display:flex; flex-direction:row; align-items:center; gap:0.3rem; line-height:1.2; }
    .player-text { display:flex; flex-direction:column; gap:0.08rem; }
    .player-main { font-size:0.82rem; font-weight:600; }
    .player-sub { font-size:0.72rem; color:#9ca3af; }

    .top-star {
      font-size: 0.8rem;
      color: #fbbf24;
      text-shadow: 0 0 6px rgba(251,191,36,0.8);
    }

    /* Gold highlight but subtle (no full-row glow) */
    .top-player-row {
      border-left: 3px solid #fbbf24;
      background: linear-gradient(to right, rgba(251,191,36,0.10), rgba(15,23,42,0.98));
    }

    tfoot td {
      font-weight:600;
      background:#020617;
      border-top:1px solid rgba(148,163,184,0.7);
      position:sticky; bottom:0; z-index:2;
    }

    .footer-note {
      margin-top:0.8rem;
      font-size:0.72rem;
      color:#9ca3af;
      display:flex;
      justify-content:flex-end;
      gap:0.5rem;
    }

    /* Toggle */
    .toggle-container { display:flex; align-items:center; gap:0.4rem; font-size:0.72rem; cursor:pointer; }
    .toggle-container input { display:none; }
    .toggle-track {
      width:38px; height:18px; border-radius:999px;
      background:#475569;
      position:relative;
      transition:0.2s;
    }
    .toggle-thumb {
      position:absolute; top:2px; left:2px;
      width:14px; height:14px; border-radius:999px;
      background:#e5e7eb;
      transition:0.2s;
    }
    .toggle-container input:checked + .toggle-track {
      background:linear-gradient(135deg,#22c55e,#16a34a);
    }
    .toggle-container input:checked + .toggle-track .toggle-thumb {
      transform: translateX(18px);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="glow blue"></div>
    <div class="glow teal"></div>

    <header class="header">
      <div class="title-block">
        <div class="title-line">
          <h1 class="app-title">Verdant Whispers Player Stats</h1>
          <span class="live-badge"><span class="live-dot"></span>LIVE</span>
        </div>
      </div>
      <div class="season-tag"><span class="status-dot"></span>SEASON 1 STATS</div>
    </header>

    <section class="summary-grid" id="summaryGrid"></section>

    <section class="table-card">
      <div class="table-header-row">
        <div>
          <div class="table-title">Player Leaderboard</div>
          <div class="table-subtitle" id="playerCountLabel">Loading players…</div>
        </div>

        <div class="controls">
          <label class="toggle-container">
            <input type="checkbox" id="hideZeroToggle" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span>Hide players with 0 GP</span>
          </label>

          <input id="searchInput" class="search-input" placeholder="Search players…" />

          <span class="status-chip" id="statusChip">
            <span class="tiny-spinner"></span>
            Fetching live data…
          </span>
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
          <tfoot id="tableFoot"></tfoot>
        </table>
      </div>
    </section>

    <div class="footer-note"><span id="footerStatus">Last updated: —</span></div>
  </div>


<script>
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQf9uGWRo14fnf7NgqImA5H1yiHvuEzysPOnvKYn2EaVITGF2dBBGdctMGGISUbIaX9h8CNGgLPAWjC/pub?gid=254200409&single=true&output=csv";

const COLS = [
  "Player","GP","Points","Goals","Assists","Saves",
  "Shots","GW","GL","MVPs","Av. PPG","GA Ratio","GS Ratio","GS %"
];

const SORT_KEYS = {
  0:"Discord", 1:"GP", 2:"Points", 3:"Goals", 4:"Assists", 5:"Saves",
  6:"Shots", 7:"GW", 8:"GL", 9:"MVPs", 10:"PPG", 11:"GAR", 12:"GSR", 13:"GSP"
};

let players = [];
let filteredPlayers = [];
let sortState = { index:2, dir:"desc" };
let topPlayerDiscord = null;

const tableHead = document.getElementById("tableHead");
const tableBody = document.getElementById("tableBody");
const tableFoot = document.getElementById("tableFoot");
const summaryGrid = document.getElementById("summaryGrid");
const searchInput = document.getElementById("searchInput");
const hideZeroToggle = document.getElementById("hideZeroToggle");
const playerCountLabel = document.getElementById("playerCountLabel");
const statusChip = document.getElementById("statusChip");
const footerStatus = document.getElementById("footerStatus");

function parseNumber(v){
  if(v==null)return 0;
  const s=String(v);
  if(/#(DIV|REF|VALUE)!/i.test(s))return 0;
  const m=s.match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):0;
}
function cleanValue(v){
  if(v==null)return "—";
  const s=String(v).trim();
  if(!s||/#(DIV|REF|VALUE)!/i.test(s))return "—";
  return s;
}
function isZeroGPPlayer(p){ return parseNumber(p.GP)===0; }

function loadSheet(){
  Papa.parse(SHEET_CSV_URL,{
    download:true,
    header:false,
    skipEmptyLines:true,
    complete:res=>{
      let rows=res.data||[];

      rows=rows.filter(r=>r.some(c=>String(c).trim()!==""));
      rows=rows.filter(r=>{
        const a=String(r[0]||"").trim().toLowerCase();
        if(!a)return false;
        if(a.includes("whole team"))return false;
        if(a==="discord")return false;
        return true;
      });

      players=rows.map(r=>({
        Discord:r[0]||"",
        Epic:r[1]||"",
        GP:r[2]||"",
        Points:r[3]||"",
        Goals:r[4]||"",
        Assists:r[5]||"",
        Saves:r[6]||"",
        Shots:r[7]||"",
        GW:r[8]||"",
        GL:r[9]||"",
        MVPs:r[10]||"",
        PPG:r[11]||"",
        GAR:r[12]||"",
        GSR:r[13]||"",
        GSP:r[14]||""
      }));

      filteredPlayers=[...players];
      identifyTopPlayer();
      buildHeader();
      buildSummaryCards();
      applySearchFilter();
      renderFoot();
      updateStatusUI();
    }
  });
}

/* Top player logic:
   MVPs -> GW -> Goals -> Assists -> Av. PPG (PPG column) ; GP > 0 only */
function identifyTopPlayer(){
  let best=null;
  players.forEach(p=>{
    if(parseNumber(p.GP)<=0)return;
    const cur={
      p,
      mvp:parseNumber(p.MVPs),
      gw:parseNumber(p.GW),
      g:parseNumber(p.Goals),
      a:parseNumber(p.Assists),
      ppg:parseNumber(p.PPG)
    };
    if(!best){ best=cur; return; }

    if(cur.mvp>best.mvp){ best=cur; return; }
    if(cur.mvp<best.mvp) return;

    if(cur.gw>best.gw){ best=cur; return; }
    if(cur.gw<best.gw) return;

    if(cur.g>best.g){ best=cur; return; }
    if(cur.g<best.g) return;

    if(cur.a>best.a){ best=cur; return; }
    if(cur.a<best.a) return;

    if(cur.ppg>best.ppg){ best=cur; return; }
  });

  topPlayerDiscord = best ? best.p.Discord : null;
}

function buildHeader(){
  let h="<tr>";
  COLS.forEach((c,i)=>{
    h+=`
      <th data-index="${i}">
        <span class="label">${c}<span class="sort-icon">▲</span></span>
      </th>`;
  });
  h+="</tr>";
  tableHead.innerHTML=h;

  tableHead.querySelectorAll("th").forEach(th=>{
    th.onclick=()=>{
      const i=parseInt(th.dataset.index,10);
      if(sortState.index===i){
        sortState.dir = sortState.dir==="asc"?"desc":"asc";
      }else{
        sortState.index=i;
        sortState.dir="desc";
      }
      applySorting();
      renderBody();
      updateSortIcons();
    };
  });

  updateSortIcons();
}

function updateSortIcons(){
  tableHead.querySelectorAll("th").forEach(th=>{
    th.classList.remove("sorted-asc","sorted-desc");
    const i=parseInt(th.dataset.index,10);
    if(i===sortState.index){
      th.classList.add(sortState.dir==="asc"?"sorted-asc":"sorted-desc");
    }
  });
}

function applySorting(){
  filteredPlayers.sort((a,b)=>{
    const key=SORT_KEYS[sortState.index];
    const av=a[key], bv=b[key];

    if(sortState.index===0){
      const as=String(av).toLowerCase(), bs=String(bv).toLowerCase();
      return sortState.dir==="asc" ? as.localeCompare(bs) : bs.localeCompare(as);
    }
    const an=parseNumber(av), bn=parseNumber(bv);
    return sortState.dir==="asc" ? an-bn : bn-an;
  });
}

function renderBody(){
  let h="";
  const top = String(topPlayerDiscord||"").trim().toLowerCase();

  filteredPlayers.forEach(p=>{
    const isTop = String(p.Discord||"").trim().toLowerCase() === top;
    h+=`<tr class="${isTop?"top-player-row":""}">`;

    h+=`
      <td>
        <div class="player-cell">
          ${isTop ? '<span class="top-star">★</span>' : ''}
          <div class="player-text">
            <span class="player-main">${cleanValue(p.Discord)}</span>
            <span class="player-sub">${cleanValue(p.Epic)}</span>
          </div>
        </div>
      </td>
    `;

    h+=`<td>${cleanValue(p.GP)}</td>`;
    h+=`<td>${cleanValue(p.Points)}</td>`;
    h+=`<td>${cleanValue(p.Goals)}</td>`;
    h+=`<td>${cleanValue(p.Assists)}</td>`;
    h+=`<td>${cleanValue(p.Saves)}</td>`;
    h+=`<td>${cleanValue(p.Shots)}</td>`;
    h+=`<td>${cleanValue(p.GW)}</td>`;
    h+=`<td>${cleanValue(p.GL)}</td>`;
    h+=`<td>${cleanValue(p.MVPs)}</td>`;
    h+=`<td>${cleanValue(p.PPG)}</td>`;
    h+=`<td>${cleanValue(p.GAR)}</td>`;
    h+=`<td>${cleanValue(p.GSR)}</td>`;
    h+=`<td>${cleanValue(p.GSP)}</td>`;

    h+="</tr>";
  });

  tableBody.innerHTML=h;
  playerCountLabel.textContent = `${filteredPlayers.length} player${filteredPlayers.length===1?"":"s"}`;
}

function renderFoot(){
  const sums={ GP:0,Points:0,Goals:0,Assists:0,Saves:0,Shots:0,GW:0,GL:0,MVPs:0 };
  players.forEach(p=>{
    sums.GP+=parseNumber(p.GP);
    sums.Points+=parseNumber(p.Points);
    sums.Goals+=parseNumber(p.Goals);
    sums.Assists+=parseNumber(p.Assists);
    sums.Saves+=parseNumber(p.Saves);
    sums.Shots+=parseNumber(p.Shots);
    sums.GW+=parseNumber(p.GW);
    sums.GL+=parseNumber(p.GL);
    sums.MVPs+=parseNumber(p.MVPs);
  });
  const avgPPG=sums.GP?(sums.Points/sums.GP).toFixed(1):"";

  let h="<tr>";
  COLS.forEach((_,i)=>{
    if(i===0){ h+="<td>Totals</td>"; }
    else{
      let v="";
      switch(i){
        case 1:v=sums.GP;break;
        case 2:v=sums.Points;break;
        case 3:v=sums.Goals;break;
        case 4:v=sums.Assists;break;
        case 5:v=sums.Saves;break;
        case 6:v=sums.Shots;break;
        case 7:v=sums.GW;break;
        case 8:v=sums.GL;break;
        case 9:v=sums.MVPs;break;
        case 10:v=avgPPG;break;
      }
      h+=`<td>${v||""}</td>`;
    }
  });
  h+="</tr>";
  tableFoot.innerHTML=h;
}

function buildSummaryCards(){
  const goals=players.reduce((a,p)=>a+parseNumber(p.Goals),0);
  const points=players.reduce((a,p)=>a+parseNumber(p.Points),0);
  const shots=players.reduce((a,p)=>a+parseNumber(p.Shots),0);
  const games=players.reduce((a,p)=>a+parseNumber(p.GP),0);
  const roster=players.length;

  const avgGoalsGame=games?((goals/games)*3).toFixed(2):"—";
  const shotPct=goals&&shots?((goals/shots)*100).toFixed(1)+"%":"—";

  const cards=[
    {label:"Roster Size",value:roster,sub:"Players"},
    {label:"Total Points",value:points,sub:"Combined leaderboard score"},
    {label:"Total Goals",value:goals,sub:games?`${avgGoalsGame} goals per game`:"Across all players"},
    {label:"Shot Accuracy",value:shotPct,sub:shots?"Goals vs shots (approx.)":"Not enough data"}
  ];

  let h="";
  cards.forEach(c=>{
    h+=`
      <article class="summary-card">
        <div class="summary-label">${c.label}</div>
        <div class="summary-value">${c.value}</div>
        <div class="summary-sub">${c.sub}</div>
      </article>`;
  });
  summaryGrid.innerHTML=h;
}

function updateStatusUI(){
  const n=new Date();
  footerStatus.textContent=`Last updated: ${n.toLocaleDateString()} ${n.toLocaleTimeString()}`;
  statusChip.textContent=`Synced at ${n.toLocaleTimeString()}`;
}

function applySearchFilter(){
  const term=(searchInput.value||"").toLowerCase().trim();
  const hide=hideZeroToggle.checked;

  filteredPlayers=players.filter(p=>{
    const d=String(p.Discord||"").toLowerCase();
    const e=String(p.Epic||"").toLowerCase();
    const matches=!term||d.includes(term)||e.includes(term);
    const passes=!hide||!isZeroGPPlayer(p);
    return matches&&passes;
  });

  applySorting();
  renderBody();
}

searchInput.addEventListener("input",applySearchFilter);
hideZeroToggle.addEventListener("change",applySearchFilter);

loadSheet();
</script>

</body>
</html>
